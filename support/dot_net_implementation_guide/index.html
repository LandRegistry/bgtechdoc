<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>.NET Implementation Guide - HM Land Registry Business Gateway Developer Pack</title>

    <link href="../../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="/support/dot_net_implementation_guide/">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:image" content="/images/govuk-large.png" />
      <meta name="twitter:title" content=".NET Implementation Guide - HM Land Registry Business Gateway Developer Pack" />
      <meta name="twitter:url" content="/support/dot_net_implementation_guide/" />

      <meta property="og:image" content="/images/govuk-large.png" />
      <meta property="og:site_name" content="HM Land Registry Business Gateway Developer Pack" />
      <meta property="og:title" content=".NET Implementation Guide" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="/support/dot_net_implementation_guide/" />

          <link href="../../favicon.ico" rel="icon" type="image/ico" />

  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/bgtechdoc" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          HM Land Registry Business Gateway Developer Pack
        </span>
      </a>
        <strong class="govuk-tag">Alpha</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value=""/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="assertive" role="alert">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#net-implementation-guide"><span>.NET Implementation Guide</span></a>
    <ul>
      <li>
        <a href="#appendix-1-c-header-code"><span>Appendix 1 – C# Header code</span></a>
      </li>
      <li>
        <a href="#appendix-2-vb-header-code"><span>Appendix 2 – VB Header code</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            
    <!---**************************************************************-->
<p><a href="../">Back to Support</a> <a href="../../">Back to Home</a></p>
<h1 id="net-implementation-guide">.NET Implementation Guide</h1>
<p>In order to use the Business Gateway you’ll need to have your certificates created and installed. This guide
assumes this has already happened, if it has not, please contact your account manager. This guide talks
through the creation of a basic C# Windows Form application. These steps work for a Web Application or an
application in VB, using versions 3, 3.5 and 4 of the .Net framework. The project will connect to the Business
Gateway and submit a request to the Daylist Enquiry service, and collect the response.</p>
<p><strong>To check your certificate is installed, navigate to this URL:
<a href="https://bgtest.landregistry.gov.uk/b2b/BGStubService/DaylistEnquiryV2_0WebService?wsdl">https://bgtest.landregistry.gov.uk/b2b/BGStubService/DaylistEnquiryV2_0WebService?wsdl</a><br>
If this is unsuccessful, your certificate is either incorrect or not installed. Please contact your account
manager. If the wsdl is displayed, please continue.<br>
Create a new C# Windows Form application<br>
Add a button to the Form and add an On Click method. (This is just to give us something to trigger the
submission)</strong></p>
<p><strong>Add a configuration file to the application. (On the Project menu, click Add New Item, select Application
Configuration File).</strong></p>
<p><strong>Open the newly created app.config, add in this xml snippet:</strong></p>
<div class="highlight"><pre class="highlight xml" tabindex="0"><code>    <span class="nt">&lt;system.net&gt;</span>
        <span class="nt">&lt;defaultProxy</span> <span class="na">useDefaultCredentials=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/system.net&gt;</span>
</code></pre></div><p><strong>Now select Add Service Reference.<br>
Enter the Service URL:
<a href="https://bgtest.landregistry.gov.uk/b2b/BGStubService/DaylistEnquiryV2_0WebService?wsdl">https://bgtest.landregistry.gov.uk/b2b/BGStubService/DaylistEnquiryV2_0WebService?wsdl</a><br>
Give the Service Contract a suitable name and select ok.<br>
This will add a load of values into your app.config file.<br>
Replace the contents of the basicHttpBinding with the snippet below:</strong></p>
<div class="highlight"><pre class="highlight xml" tabindex="0"><code><span class="nt">&lt;binding</span> <span class="na">name=</span><span class="s">"CertPortBinding"</span> <span class="na">closeTimeout=</span><span class="s">"00:01:00"</span> <span class="na">openTimeout=</span><span class="s">"00:01:00"</span>
<span class="na">receiveTimeout=</span><span class="s">"00:10:00"</span> <span class="na">sendTimeout=</span><span class="s">"00:01:00"</span> <span class="na">bypassProxyOnLocal=</span><span class="s">"false"</span>
<span class="na">hostNameComparisonMode=</span><span class="s">"StrongWildcard"</span> <span class="na">maxBufferSize=</span><span class="s">"65536000"</span> <span class="na">maxBufferPoolSize=</span><span class="s">"524288"</span>
<span class="na">maxReceivedMessageSize=</span><span class="s">"65536000"</span> <span class="na">messageEncoding=</span><span class="s">"Text"</span> <span class="na">textEncoding=</span><span class="s">"utf-8"</span>
<span class="na">useDefaultWebProxy=</span><span class="s">"true"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;readerQuotas</span> <span class="na">maxDepth=</span><span class="s">"32"</span> <span class="na">maxStringContentLength=</span><span class="s">"65536000"</span> <span class="na">maxArrayLength=</span><span class="s">"16384"</span>
    <span class="na">maxBytesPerRead=</span><span class="s">"4096"</span> <span class="na">maxNameTableCharCount=</span><span class="s">"16384"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;security</span> <span class="na">mode=</span><span class="s">"Transport"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;transport</span> <span class="na">clientCredentialType=</span><span class="s">"Certificate"</span> <span class="na">proxyCredentialType=</span><span class="s">"None"</span>
        <span class="na">realm=</span><span class="s">""</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;message</span> <span class="na">clientCredentialType=</span><span class="s">"UserName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/security&gt;</span>
<span class="nt">&lt;/binding&gt;</span>
</code></pre></div><p>This has a number of changes to the default values, security mode has been changed to transport,
this tells the application a certificate is going to be sent along with the request for authentication,
various message size values have been increased to handle larger responses from Land Registry.
Now we need to add a behaviour to the Service Model to tell the application which certificate to
use.</p>
<p><strong>Add the following snippet to your app.config.<br>
Add in the correct serial number (this will be something like “47 cc b3 01”)</strong></p>
<div class="highlight"><pre class="highlight xml" tabindex="0"><code><span class="nt">&lt;behaviors&gt;</span>
    <span class="nt">&lt;endpointBehaviors&gt;</span>
        <span class="nt">&lt;behavior</span> <span class="na">name=</span><span class="s">"prodCert"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;clientCredentials&gt;</span>
                <span class="nt">&lt;clientCertificate</span> <span class="na">findValue=</span><span class="s">"serialNumberHere"</span>
                <span class="na">x509FindType=</span><span class="s">"FindBySerialNumber"</span> <span class="na">storeLocation=</span><span class="s">"CurrentUser"</span>
                <span class="na">storeName=</span><span class="s">"My"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;serviceCertificate&gt;</span>
                    <span class="nt">&lt;authentication</span> <span class="na">certificateValidationMode=</span><span class="s">"PeerTrust"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;/serviceCertificate&gt;</span>
            <span class="nt">&lt;/clientCredentials&gt;</span>
        <span class="nt">&lt;/behavior&gt;</span>
    <span class="nt">&lt;/endpointBehaviors&gt;</span>
<span class="nt">&lt;/behaviors&gt;</span>
</code></pre></div><p>Now we need to tell the endpoint to use the new behaviour.</p>
<p><strong>Within the app.config file, locate the endpoint that has already been added and add in this attribute:
behaviorConfiguration=&ldquo;prodCert&rdquo;</strong></p>
<p><strong>Change the bindingConfiguration to be the newly created CertPortBinding<br>
Update the URL to correct the target server:<br>
Replace: <a href="https://z0.b2b.http.server.landregistry.gov:13007/">https://z0.b2b.http.server.landregistry.gov:13007/</a><br>
With: <a href="https://bgtest.landregistry.gov.uk/b2b/">https://bgtest.landregistry.gov.uk/b2b/</a></strong></p>
<p>That’s us done in the app.config. You should have something like this:</p>
<div class="highlight"><pre class="highlight xml" tabindex="0"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;system.net&gt;</span>
        <span class="nt">&lt;defaultProxy</span> <span class="na">useDefaultCredentials=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/system.net&gt;</span>
    <span class="nt">&lt;system.serviceModel&gt;</span>
        <span class="nt">&lt;bindings&gt;</span>
            <span class="nt">&lt;basicHttpBinding&gt;</span>
                <span class="nt">&lt;binding</span> <span class="na">name=</span><span class="s">"CertPortBinding"</span> <span class="na">closeTimeout=</span><span class="s">"00:01:00"</span> <span class="na">openTimeout=</span><span class="s">"00:01:00"</span> <span class="na">receiveTimeout=</span><span class="s">"00:10:00"</span>
                <span class="na">sendTimeout=</span><span class="s">"00:01:00"</span> <span class="na">bypassProxyOnLocal=</span><span class="s">"false"</span> <span class="na">hostNameComparisonMode=</span><span class="s">"StrongWildcard"</span> <span class="na">maxBufferSize=</span><span class="s">"65536000"</span>
                <span class="na">maxBufferPoolSize=</span><span class="s">"524288"</span> <span class="na">maxReceivedMessageSize=</span><span class="s">"65536000"</span>
                <span class="na">messageEncoding=</span><span class="s">"Text"</span> <span class="na">textEncoding=</span><span class="s">"utf-8"</span> <span class="na">useDefaultWebProxy=</span><span class="s">"true"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;readerQuotas</span> <span class="na">maxDepth=</span><span class="s">"32"</span> <span class="na">maxStringContentLength=</span><span class="s">"65536000"</span><span class="na">maxArrayLength=</span><span class="s">"16384"</span> <span class="na">maxBytesPerRead=</span><span class="s">"4096"</span>
                    <span class="na">maxNameTableCharCount=</span><span class="s">"16384"</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;security</span> <span class="na">mode=</span><span class="s">"Transport"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;transport</span> <span class="na">clientCredentialType=</span><span class="s">"Certificate"</span> <span class="na">proxyCredentialType=</span><span class="s">"None"</span> <span class="na">realm=</span><span class="s">""</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;message</span> <span class="na">clientCredentialType=</span><span class="s">"UserName"</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;/security&gt;</span>
                <span class="nt">&lt;/binding&gt;</span>
            <span class="nt">&lt;/basicHttpBinding&gt;</span>
        <span class="nt">&lt;/bindings&gt;</span>
        <span class="nt">&lt;client&gt;</span>
            <span class="nt">&lt;endpoint</span> <span class="na">address=</span><span class="s">"https://bgtest.landregistry.gov.uk/b2b/BGStubService/DaylistEnquiryV2_0WebService"</span>
            <span class="na">behaviorConfiguration=</span><span class="s">"prodCert"</span> <span class="na">binding=</span><span class="s">"basicHttpBinding"</span> <span class="na">bindingConfiguration=</span><span class="s">"CertPortBinding"</span>
            <span class="na">contract=</span><span class="s">"DleServRef.DaylistEnquiryV2_0Service"</span>
            <span class="na">name=</span><span class="s">"DaylistEnquiryV2_0WSImplPort"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/client&gt;</span>
        <span class="nt">&lt;behaviors&gt;</span>
            <span class="nt">&lt;endpointBehaviors&gt;</span>
                <span class="nt">&lt;behavior</span> <span class="na">name=</span><span class="s">"prodCert"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;clientCredentials&gt;</span>
                        <span class="nt">&lt;clientCertificate</span> <span class="na">findValue=</span><span class="s">"47 cc b3 01"</span> <span class="na">x509FindType=</span><span class="s">"FindBySerialNumber"</span> <span class="na">storeLocation=</span><span class="s">"CurrentUser"</span> <span class="na">storeName=</span><span class="s">"My"</span><span class="nt">/&gt;</span>
                        <span class="nt">&lt;serviceCertificate&gt;</span>
                            <span class="nt">&lt;authentication</span> <span class="na">certificateValidationMode=</span><span class="s">"PeerTrust"</span><span class="nt">/&gt;</span>
                        <span class="nt">&lt;/serviceCertificate&gt;</span>
                    <span class="nt">&lt;/clientCredentials&gt;</span>
                <span class="nt">&lt;/behavior&gt;</span>
            <span class="nt">&lt;/endpointBehaviors&gt;</span>
        <span class="nt">&lt;/behaviors&gt;</span>
    <span class="nt">&lt;/system.serviceModel&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</code></pre></div><p><strong>Open the source code for your form and include the Service Reference created earlier in the import
statements at the top.<br>
using ApplicationName.ServRefName;</strong></p>
<p><strong>Go to the OnClick method we created earlier and add the following code. This creates an instance of the
client and request object, it then populates the request with some values and submits it against the
service.</strong></p>
<div class="highlight"><pre class="highlight csharp" tabindex="0"><code><span class="c1">// create an instance of the client</span>
<span class="n">DaylistEnquiryV2_0ServiceClient</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DaylistEnquiryV2_0ServiceClient</span><span class="p">();</span>
<span class="c1">// create a request object</span>
<span class="n">RequestDaylistEnquiryV2_0Type</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RequestDaylistEnquiryV2_0Type</span><span class="p">();</span>
<span class="c1">// populate it</span>
<span class="n">request</span><span class="p">.</span><span class="n">ID</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Q1IdentifierType</span><span class="p">();</span>
<span class="n">request</span><span class="p">.</span><span class="n">ID</span><span class="p">.</span><span class="n">MessageID</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Q1TextType</span><span class="p">();</span>
<span class="n">request</span><span class="p">.</span><span class="n">ID</span><span class="p">.</span><span class="n">MessageID</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="s">"testsuccessmanyresults"</span><span class="p">;</span>
<span class="n">request</span><span class="p">.</span><span class="n">Product</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Q1ProductType</span><span class="p">();</span>
<span class="n">request</span><span class="p">.</span><span class="n">Product</span><span class="p">.</span><span class="n">ContinueIfTitleIsClosedAndContinuedIndicator</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">IndicatorType</span><span class="p">();</span>
<span class="n">request</span><span class="p">.</span><span class="n">Product</span><span class="p">.</span><span class="n">ContinueIfTitleIsClosedAndContinuedIndicator</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
<span class="n">request</span><span class="p">.</span><span class="n">Product</span><span class="p">.</span><span class="n">ExternalReference</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Q1ExternalReferenceType</span><span class="p">();</span>
<span class="n">request</span><span class="p">.</span><span class="n">Product</span><span class="p">.</span><span class="n">ExternalReference</span><span class="p">.</span><span class="n">Reference</span> <span class="p">=</span> <span class="s">"DotNetQuickStartReference"</span><span class="p">;</span>
<span class="n">request</span><span class="p">.</span><span class="n">Product</span><span class="p">.</span><span class="n">SubjectProperty</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Q1SubjectPropertyType</span><span class="p">();</span>
<span class="n">request</span><span class="p">.</span><span class="n">Product</span><span class="p">.</span><span class="n">SubjectProperty</span><span class="p">.</span><span class="n">TitleNumber</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Q2TextType</span><span class="p">();</span>
<span class="n">request</span><span class="p">.</span><span class="n">Product</span><span class="p">.</span><span class="n">SubjectProperty</span><span class="p">.</span><span class="n">TitleNumber</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="s">"DN100"</span><span class="p">;</span>
<span class="c1">// submit the request</span>
<span class="n">ResponseDaylistEnquiryV2_0Type</span> <span class="n">response</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">daylistEnquiry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"Application Processed"</span><span class="p">);</span>
</code></pre></div><p>If you try to run this now and submit the request you should get an error stating <em>SOAP
Header does not have wsse:Security element.</em> Requests submitted via Business Gateway
must contain the login credentials of the user making the submission within the Soap
Header.</p>
<p><strong>See Appendix 1 for the C# code to create a header in the necessary format (Appendix 2 contains the code
converted to VB).<br>
To use this code, add it to a class in your project, then add an instance of it to your client by adding the
following code after you’ve created the client (for production, you’ll need to insert the correct
username+password combination):</strong></p>
<div class="highlight"><pre class="highlight csharp" tabindex="0"><code><span class="n">client</span><span class="p">.</span><span class="n">ChannelFactory</span><span class="p">.</span><span class="n">Endpoint</span><span class="p">.</span><span class="n">Behaviors</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span>
<span class="nf">HMLRBGMessageEndpointBehavior</span><span class="p">(</span><span class="s">"BGUser001"</span><span class="p">,</span><span class="s">"landreg001"</span><span class="p">));</span>
</code></pre></div><p>If you now run this, you should get the Exception ‘Application Processed’. This means you have
successfully submitted a request to the Business Gateway test environment, using the certificate and
user credentials to authenticate. When you add all of services you’re going to be using, add all the
service references you are going to use up front, then each endpoint can use the same binding and
behaviour. An example app.config with multiple endpoints is below:</p>
<div class="highlight"><pre class="highlight xml" tabindex="0"><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;system.net&gt;</span>
        <span class="nt">&lt;defaultProxy</span> <span class="na">useDefaultCredentials=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/system.net&gt;</span>
    <span class="nt">&lt;system.serviceModel&gt;</span>
        <span class="nt">&lt;bindings&gt;</span>
            <span class="nt">&lt;basicHttpBinding&gt;</span>
                <span class="nt">&lt;binding</span> <span class="na">name=</span><span class="s">"CertPortBinding"</span> <span class="na">closeTimeout=</span><span class="s">"00:01:00"</span> <span class="na">openTimeout=</span><span class="s">"00:01:00"</span>
                <span class="na">receiveTimeout=</span><span class="s">"00:10:00"</span> <span class="na">sendTimeout=</span><span class="s">"00:01:00"</span> <span class="na">bypassProxyOnLocal=</span><span class="s">"false"</span>
                <span class="na">hostNameComparisonMode=</span><span class="s">"StrongWildcard"</span> <span class="na">maxBufferSize=</span><span class="s">"65536000"</span> <span class="na">maxBufferPoolSize=</span><span class="s">"524288"</span>
                <span class="na">maxReceivedMessageSize=</span><span class="s">"65536000"</span> <span class="na">messageEncoding=</span><span class="s">"Text"</span> <span class="na">textEncoding=</span><span class="s">"utf-8"</span> <span class="na">useDefaultWebProxy=</span><span class="s">"true"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;readerQuotas</span> <span class="na">maxDepth=</span><span class="s">"32"</span> <span class="na">maxStringContentLength=</span><span class="s">"65536000"</span> <span class="na">maxArrayLength=</span><span class="s">"16384"</span>
                    <span class="na">maxBytesPerRead=</span><span class="s">"4096"</span> <span class="na">maxNameTableCharCount=</span><span class="s">"16384"</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;security</span> <span class="na">mode=</span><span class="s">"Transport"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;transport</span> <span class="na">clientCredentialType=</span><span class="s">"Certificate"</span> <span class="na">proxyCredentialType=</span><span class="s">"None"</span> <span class="na">realm=</span><span class="s">""</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;message</span> <span class="na">clientCredentialType=</span><span class="s">"UserName"</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;/security&gt;</span>
                <span class="nt">&lt;/binding&gt;</span>
            <span class="nt">&lt;/basicHttpBinding&gt;</span>
        <span class="nt">&lt;/bindings&gt;</span>
        <span class="nt">&lt;client&gt;</span>
            <span class="nt">&lt;endpoint</span> <span class="na">address=</span><span class="s">"https://bgtest.landregistry.gov.uk/b2b/ECDRS_StubService/CorrespondenceV1_0PollRequestWebService"</span>
            <span class="na">behaviorConfiguration=</span><span class="s">"prodCert"</span> <span class="na">binding=</span><span class="s">"basicHttpBinding"</span> <span class="na">bindingConfiguration=</span><span class="s">"CertPortBinding"</span>
            <span class="na">contract=</span><span class="s">"CorresStub.CorrespondenceV1_0PollRequestService"</span> <span class="na">name=</span><span class="s">"LiveStubCorres"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;endpoint</span> <span class="na">address=</span><span class="s">"https://bgtest.landregistry.gov.uk/b2b/BGStubService/OutstandingRequestsV2_0WebService"</span>
            <span class="na">behaviorConfiguration=</span><span class="s">"prodCert"</span> <span class="na">binding=</span><span class="s">"basicHttpBinding"</span> <span class="na">bindingConfiguration=</span><span class="s">"CertPortBinding"</span>
            <span class="na">contract=</span><span class="s">"OutstandingRequestsStub.OutstandingRequestsV2_0Service"</span> <span class="na">name=</span><span class="s">"LiveStubOR"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;endpoint</span> <span class="na">address=</span><span class="s">"https://bgtest.landregistry.gov.uk/b2b/ECDRS_StubService/EDocumentRegistrationV1_0PollRequestWebService"</span>
            <span class="na">behaviorConfiguration=</span><span class="s">"prodCert"</span> <span class="na">binding=</span><span class="s">"basicHttpBinding"</span> <span class="na">bindingConfiguration=</span><span class="s">"CertPortBinding"</span>
            <span class="na">contract=</span><span class="s">"DrsPollStub.EDocumentRegistrationV1_0PollRequestService"</span> <span class="na">name=</span><span class="s">"LiveStubDrsPoll"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;endpoint</span> <span class="na">address=</span><span class="s">"https://bgtest.landregistry.gov.uk/b2b/ECDRS_StubService/EDocumentRegistrationV1_0WebService"</span>
            <span class="na">behaviorConfiguration=</span><span class="s">"prodCert"</span> <span class="na">binding=</span><span class="s">"basicHttpBinding"</span> <span class="na">bindingConfiguration=</span><span class="s">"CertPortBinding"</span>
            <span class="na">contract=</span><span class="s">"DrsStub.EDocumentRegistrationV1_0Service"</span> <span class="na">name=</span><span class="s">"LiveStubDrs"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/client&gt;</span>
        <span class="nt">&lt;behaviors&gt;</span>
            <span class="nt">&lt;endpointBehaviors&gt;</span>
                <span class="nt">&lt;behavior</span> <span class="na">name=</span><span class="s">"prodCert"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;clientCredentials&gt;</span>
                        <span class="nt">&lt;clientCertificate</span> <span class="na">findValue=</span><span class="s">"47 cc b3 01"</span> <span class="na">x509FindType=</span><span class="s">"FindBySerialNumber"</span> <span class="na">storeLocation=</span><span class="s">"CurrentUser"</span> <span class="na">storeName=</span><span class="s">"My"</span><span class="nt">/&gt;</span>
                        <span class="nt">&lt;serviceCertificate&gt;</span>
                            <span class="nt">&lt;authentication</span> <span class="na">certificateValidationMode=</span><span class="s">"PeerTrust"</span><span class="nt">/&gt;</span>
                        <span class="nt">&lt;/serviceCertificate&gt;</span>
                    <span class="nt">&lt;/clientCredentials&gt;</span>
                <span class="nt">&lt;/behavior&gt;</span>
            <span class="nt">&lt;/endpointBehaviors&gt;</span>
        <span class="nt">&lt;/behaviors&gt;</span>
    <span class="nt">&lt;/system.serviceModel&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</code></pre></div><h2 id="appendix-1-c-header-code">Appendix 1 – C# Header code</h2>
<div class="highlight"><pre class="highlight csharp" tabindex="0"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Xml</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Xml.Serialization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Security.Cryptography.X509Certificates</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ServiceModel.Description</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ServiceModel.Dispatcher</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ServiceModel.Channels</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ServiceModel</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">HMLRBGMessageInspector</span> <span class="p">:</span> <span class="n">IClientMessageInspector</span>
<span class="p">{</span>
    <span class="err">#</span><span class="n">region</span> <span class="n">Member</span> <span class="n">Variables</span>

    <span class="k">private</span> <span class="kt">string</span> <span class="n">m_Username</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">m_Password</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>

    <span class="err">#</span><span class="n">endregion</span>

    <span class="err">#</span><span class="n">region</span> <span class="n">Constructor</span>

    <span class="k">public</span> <span class="nf">HMLRBGMessageInspector</span><span class="p">(</span><span class="kt">string</span> <span class="n">username</span><span class="p">,</span> <span class="kt">string</span> <span class="n">password</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_Username</span> <span class="p">=</span> <span class="n">username</span><span class="p">;</span>
        <span class="n">m_Password</span> <span class="p">=</span> <span class="n">password</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="err">#</span><span class="n">endregion</span>

    <span class="err">#</span><span class="n">region</span> <span class="n">IClientMessageInspector</span> <span class="n">Methods</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">AfterReceiveReply</span><span class="p">(</span><span class="k">ref</span> <span class="n">Message</span> <span class="n">reply</span><span class="p">,</span> <span class="kt">object</span> <span class="n">correlationState</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">object</span> <span class="nf">BeforeSendRequest</span><span class="p">(</span><span class="k">ref</span> <span class="n">Message</span> <span class="n">request</span><span class="p">,</span> <span class="n">IClientChannel</span> <span class="n">channel</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Create the WsseSecurityHeader with the current user credetials.</span>
        <span class="n">MessageHeader</span> <span class="n">wsseHeader</span> <span class="p">=</span> <span class="nf">CreateWsseSecurityHeader</span><span class="p">();</span>
        <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">wsseHeader</span><span class="p">);</span>

        <span class="c1">// Create the i18nHeader with the locale settings.</span>
        <span class="n">MessageHeader</span> <span class="n">i18nHeader</span> <span class="p">=</span> <span class="nf">CreateI18nHeader</span><span class="p">();</span>
        <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">i18nHeader</span><span class="p">);</span>

        <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Action</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

        <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="err">#</span><span class="n">endregion</span>

    <span class="err">#</span><span class="n">region</span> <span class="n">Private</span> <span class="n">Methods</span>

    <span class="k">private</span> <span class="n">MessageHeader</span> <span class="nf">CreateWsseSecurityHeader</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">XmlDocument</span> <span class="n">doc</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">XmlDocument</span><span class="p">();</span>

        <span class="n">StringBuilder</span> <span class="n">xml</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>

        <span class="n">xml</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="s">"&lt;UsernameToken xmlns=\"http://docs.oasis-
</span><span class="n">open</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">wss</span><span class="p">/</span><span class="m">2004</span><span class="p">/</span><span class="m">01</span><span class="p">/</span><span class="n">oasis</span><span class="p">-</span><span class="m">200401</span><span class="p">-</span><span class="n">wss</span><span class="p">-</span><span class="n">wssecurity</span><span class="p">-</span><span class="n">secext</span><span class="p">-</span><span class="m">1.0</span><span class="p">.</span><span class="n">xsd</span><span class="err">\</span><span class="s">"&gt;"</span><span class="p">);</span>
        <span class="n">xml</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="s">"&lt;Username&gt;"</span><span class="p">);</span>
        <span class="n">xml</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="n">m_Username</span><span class="p">);</span>
        <span class="n">xml</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="s">"&lt;/Username&gt;"</span><span class="p">);</span>
        <span class="n">xml</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="s">"&lt;Password&gt;"</span><span class="p">);</span>
        <span class="n">xml</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="n">m_Password</span><span class="p">);</span>
        <span class="n">xml</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="s">"&lt;/Password&gt;"</span><span class="p">);</span>
        <span class="n">xml</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="s">"&lt;/UsernameToken&gt;"</span><span class="p">);</span>

        <span class="n">doc</span><span class="p">.</span><span class="nf">LoadXml</span><span class="p">(</span><span class="n">xml</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>

        <span class="k">return</span> <span class="n">MessageHeader</span><span class="p">.</span><span class="nf">CreateHeader</span><span class="p">(</span><span class="s">"Security"</span><span class="p">,</span> <span class="s">"http://docs.oasis-
</span><span class="n">open</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">wss</span><span class="p">/</span><span class="m">2004</span><span class="p">/</span><span class="m">01</span><span class="p">/</span><span class="n">oasis</span><span class="p">-</span><span class="m">200401</span><span class="p">-</span><span class="n">wss</span><span class="p">-</span><span class="n">wssecurity</span><span class="p">-</span><span class="n">secext</span><span class="p">-</span><span class="m">1.0</span><span class="p">.</span><span class="n">xsd</span><span class="s">",
</span><span class="n">doc</span><span class="p">.</span><span class="n">DocumentElement</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">MessageHeader</span> <span class="nf">CreateI18nHeader</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">XmlDocument</span> <span class="n">doc</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">XmlDocument</span><span class="p">();</span>
        <span class="n">doc</span><span class="p">.</span><span class="nf">LoadXml</span><span class="p">(</span><span class="s">"&lt;locale xmlns=\"http://www.w3.org/2005/09/ws-
</span><span class="n">i18n</span><span class="err">\</span><span class="s">"&gt;en&lt;/locale&gt;"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">MessageHeader</span><span class="p">.</span><span class="nf">CreateHeader</span><span class="p">(</span><span class="s">"international"</span><span class="p">,</span>
<span class="s">"http://www.w3.org/2005/09/ws-i18n"</span><span class="p">,</span> <span class="n">doc</span><span class="p">.</span><span class="n">DocumentElement</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="err">#</span><span class="n">endregion</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">HMLRBGMessageEndpointBehavior</span> <span class="p">:</span> <span class="n">Attribute</span><span class="p">,</span> <span class="n">IEndpointBehavior</span><span class="p">,</span>
<span class="n">IOperationBehavior</span><span class="p">,</span> <span class="n">IContractBehavior</span>
<span class="p">{</span>
    <span class="err">#</span><span class="n">region</span> <span class="n">Member</span> <span class="n">Variables</span>

    <span class="k">private</span> <span class="kt">string</span> <span class="n">m_Username</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">m_Password</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>

    <span class="err">#</span><span class="n">endregion</span>

    <span class="err">#</span><span class="n">region</span> <span class="n">Constructor</span>

    <span class="k">public</span> <span class="nf">HMLRBGMessageEndpointBehavior</span><span class="p">(</span><span class="kt">string</span> <span class="n">username</span><span class="p">,</span> <span class="kt">string</span> <span class="n">password</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_Username</span> <span class="p">=</span> <span class="n">username</span><span class="p">;</span>
        <span class="n">m_Password</span> <span class="p">=</span> <span class="n">password</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="err">#</span><span class="n">endregion</span>

    <span class="err">#</span><span class="n">region</span> <span class="n">IEndpointBehavior</span> <span class="n">Methods</span>

    <span class="k">void</span> <span class="n">IEndpointBehavior</span><span class="p">.</span><span class="nf">AddBindingParameters</span><span class="p">(</span><span class="n">ServiceEndpoint</span> <span class="n">endpoint</span><span class="p">,</span>
<span class="n">BindingParameterCollection</span> <span class="n">bindingParameters</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">void</span> <span class="n">IEndpointBehavior</span><span class="p">.</span><span class="nf">ApplyClientBehavior</span><span class="p">(</span><span class="n">ServiceEndpoint</span> <span class="n">endpoint</span><span class="p">,</span>
<span class="n">System</span><span class="p">.</span><span class="n">ServiceModel</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="n">ClientRuntime</span> <span class="n">clientRuntime</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">clientRuntime</span><span class="p">.</span><span class="n">MessageInspectors</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">HMLRBGMessageInspector</span><span class="p">(</span><span class="n">m_Username</span><span class="p">,</span>
<span class="n">m_Password</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="n">IEndpointBehavior</span><span class="p">.</span><span class="nf">ApplyDispatchBehavior</span><span class="p">(</span><span class="n">ServiceEndpoint</span> <span class="n">endpoint</span><span class="p">,</span>
<span class="n">System</span><span class="p">.</span><span class="n">ServiceModel</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="n">EndpointDispatcher</span> <span class="n">endpointDispatcher</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">void</span> <span class="n">IEndpointBehavior</span><span class="p">.</span><span class="nf">Validate</span><span class="p">(</span><span class="n">ServiceEndpoint</span> <span class="n">endpoint</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="err">#</span><span class="n">endregion</span>

    <span class="err">#</span><span class="n">region</span> <span class="n">IOperationBehavior</span> <span class="n">Members</span>

    <span class="k">void</span> <span class="n">IOperationBehavior</span><span class="p">.</span><span class="nf">AddBindingParameters</span><span class="p">(</span><span class="n">OperationDescription</span>
<span class="n">operationDescription</span><span class="p">,</span> <span class="n">BindingParameterCollection</span> <span class="n">bindingParameters</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">void</span> <span class="n">IOperationBehavior</span><span class="p">.</span><span class="nf">ApplyClientBehavior</span><span class="p">(</span><span class="n">OperationDescription</span>
<span class="n">operationDescription</span><span class="p">,</span> <span class="n">ClientOperation</span> <span class="n">clientOperation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">clientOperation</span><span class="p">.</span><span class="n">Parent</span><span class="p">.</span><span class="n">MessageInspectors</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span>
        <span class="nf">HMLRBGMessageInspector</span><span class="p">(</span><span class="n">m_Username</span><span class="p">,</span> <span class="n">m_Password</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="n">IOperationBehavior</span><span class="p">.</span><span class="nf">ApplyDispatchBehavior</span><span class="p">(</span><span class="n">OperationDescription</span>
<span class="n">operationDescription</span><span class="p">,</span> <span class="n">DispatchOperation</span> <span class="n">dispatchOperation</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="c1">//throw new NotImplementedException();</span>

    <span class="p">}</span>

    <span class="k">void</span> <span class="n">IOperationBehavior</span><span class="p">.</span><span class="nf">Validate</span><span class="p">(</span><span class="n">OperationDescription</span> <span class="n">operationDescription</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="c1">// throw new NotImplementedException();</span>

    <span class="p">}</span>

    <span class="err">#</span><span class="n">endregion</span>

    <span class="err">#</span><span class="n">region</span> <span class="n">IContractBehavior</span> <span class="n">Members</span>

    <span class="k">void</span> <span class="n">IContractBehavior</span><span class="p">.</span><span class="nf">AddBindingParameters</span><span class="p">(</span><span class="n">ContractDescription</span>
<span class="n">contractDescription</span><span class="p">,</span> <span class="n">ServiceEndpoint</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">BindingParameterCollection</span>
<span class="n">bindingParameters</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">void</span> <span class="n">IContractBehavior</span><span class="p">.</span><span class="nf">ApplyClientBehavior</span><span class="p">(</span><span class="n">ContractDescription</span>
<span class="n">contractDescription</span><span class="p">,</span> <span class="n">ServiceEndpoint</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">ClientRuntime</span> <span class="n">clientRuntime</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">clientRuntime</span><span class="p">.</span><span class="n">MessageInspectors</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">HMLRBGMessageInspector</span><span class="p">(</span><span class="n">m_Username</span><span class="p">,</span>
<span class="n">m_Password</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="n">IContractBehavior</span><span class="p">.</span><span class="nf">ApplyDispatchBehavior</span><span class="p">(</span><span class="n">ContractDescription</span>
<span class="n">contractDescription</span><span class="p">,</span> <span class="n">ServiceEndpoint</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">DispatchRuntime</span> <span class="n">dispatchRuntime</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="c1">//throw new NotImplementedException();</span>

    <span class="p">}</span>

    <span class="k">void</span> <span class="n">IContractBehavior</span><span class="p">.</span><span class="nf">Validate</span><span class="p">(</span><span class="n">ContractDescription</span> <span class="n">contractDescription</span><span class="p">,</span>
<span class="n">ServiceEndpoint</span> <span class="n">endpoint</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="c1">//throw new NotImplementedException();</span>

    <span class="p">}</span>

    <span class="err">#</span><span class="n">endregion</span>

<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">AcceptAllCertificatePolicy</span> <span class="p">:</span> <span class="n">ICertificatePolicy</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">AcceptAllCertificatePolicy</span><span class="p">()</span>
    <span class="p">{</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">CheckValidationResult</span><span class="p">(</span><span class="n">ServicePoint</span> <span class="n">sPoint</span><span class="p">,</span> <span class="n">X509Certificate</span> <span class="n">cert</span><span class="p">,</span>
<span class="n">WebRequest</span> <span class="n">wRequest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">certProb</span><span class="p">)</span>
    <span class="p">{</span>   
        <span class="c1">// *** Always accept</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="appendix-2-vb-header-code">Appendix 2 – VB Header code</h2>
<div class="highlight"><pre class="highlight vb" tabindex="0"><code><span class="k">Imports</span> <span class="nn">System.ServiceModel</span>
<span class="k">Imports</span> <span class="nn">System.ServiceModel.Web</span>
<span class="k">Imports</span> <span class="nn">System.Text</span>
<span class="k">Imports</span> <span class="nn">System.Collections</span>
<span class="k">Imports</span> <span class="nn">System.ServiceModel.Channels</span>
<span class="k">Imports</span> <span class="nn">System.ServiceModel.Description</span>
<span class="k">Imports</span> <span class="nn">System.ServiceModel.Dispatcher</span>
<span class="k">Imports</span> <span class="nn">System.Xml</span>
<span class="k">Imports</span> <span class="nn">System.Net</span>
<span class="k">Imports</span> <span class="nn">System.Security.Cryptography.X509Certificates</span>
<span class="k">Imports</span> <span class="nn">System.IO</span>

<span class="k">Public</span> <span class="k">Class</span> <span class="nc">HMLRBGMessageInspector</span>
    <span class="k">Implements</span> <span class="n">IClientMessageInspector</span>

    <span class="k">Public</span> <span class="k">Sub</span> <span class="nf">AfterReceiveReply</span><span class="p">(</span><span class="k">ByRef</span> <span class="n">reply</span> <span class="ow">As</span> <span class="n">System</span><span class="p">.</span><span class="n">ServiceModel</span><span class="p">.</span><span class="n">Channels</span><span class="p">.</span><span class="n">Message</span><span class="p">,</span> <span class="k">ByVal</span>
<span class="n">correlationState</span> <span class="ow">As</span> <span class="kt">Object</span><span class="p">)</span> <span class="k">Implements</span>
<span class="n">System</span><span class="p">.</span><span class="n">ServiceModel</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="n">IClientMessageInspector</span><span class="p">.</span><span class="n">AfterReceiveReply</span>

    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Public</span> <span class="k">Function</span> <span class="nf">BeforeSendRequest1</span><span class="p">(</span><span class="k">ByRef</span> <span class="n">request</span> <span class="ow">As</span>
<span class="n">System</span><span class="p">.</span><span class="n">ServiceModel</span><span class="p">.</span><span class="n">Channels</span><span class="p">.</span><span class="n">Message</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">channel</span> <span class="ow">As</span> <span class="n">System</span><span class="p">.</span><span class="n">ServiceModel</span><span class="p">.</span><span class="n">IClientChannel</span><span class="p">)</span>
<span class="ow">As</span> <span class="kt">Object</span> <span class="k">Implements</span>
<span class="n">System</span><span class="p">.</span><span class="n">ServiceModel</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="n">IClientMessageInspector</span><span class="p">.</span><span class="n">BeforeSendRequest</span>
        <span class="c1">' Create the WsseSecurityHeader with the current user credetials.</span>
        <span class="k">Dim</span> <span class="nv">wsseHeader</span> <span class="ow">As</span> <span class="n">MessageHeader</span> <span class="o">=</span> <span class="n">CreateWsseSecurityHeader</span><span class="p">()</span>
        <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wsseHeader</span><span class="p">)</span>

        <span class="c1">' Create the i18nHeader with the locale settings.</span>
        <span class="k">Dim</span> <span class="nv">i18nHeader</span> <span class="ow">As</span> <span class="n">MessageHeader</span> <span class="o">=</span> <span class="n">CreateI18nHeader</span><span class="p">()</span>
        <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">i18nHeader</span><span class="p">)</span>

        <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Action</span> <span class="o">=</span> <span class="k">Nothing</span>

        <span class="k">Return</span> <span class="k">Nothing</span>
    <span class="k">End</span> <span class="k">Function</span>

    <span class="k">Private</span> <span class="n">m_Username</span> <span class="ow">As</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">Private</span> <span class="n">m_Password</span> <span class="ow">As</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>


    <span class="k">Public</span> <span class="k">Sub</span> <span class="nf">New</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">username</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">password</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">)</span>
        <span class="n">m_Username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="n">m_Password</span> <span class="o">=</span> <span class="n">password</span>
    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Private</span> <span class="k">Function</span> <span class="nf">CreateWsseSecurityHeader</span><span class="p">()</span> <span class="ow">As</span> <span class="n">MessageHeader</span>
        <span class="k">Dim</span> <span class="nv">doc</span> <span class="ow">As</span> <span class="k">New</span> <span class="n">XmlDocument</span><span class="p">()</span>

        <span class="k">Dim</span> <span class="nv">xml</span> <span class="ow">As</span> <span class="k">New</span> <span class="n">StringBuilder</span><span class="p">()</span>

        <span class="n">xml</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">"&lt;UsernameToken xmlns=</span><span class="se">""</span><span class="s">http://docs.oasis-open.org/wss/2004/01/oasis-
200401-wss-wssecurity-secext-1.0.xsd</span><span class="se">""</span><span class="s">&gt;"</span><span class="p">)</span>
        <span class="n">xml</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">"&lt;Username&gt;"</span><span class="p">)</span>
        <span class="n">xml</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">m_Username</span><span class="p">)</span>
        <span class="n">xml</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">"&lt;/Username&gt;"</span><span class="p">)</span>
        <span class="n">xml</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">"&lt;Password&gt;"</span><span class="p">)</span>
        <span class="n">xml</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">m_Password</span><span class="p">)</span>
        <span class="n">xml</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">"&lt;/Password&gt;"</span><span class="p">)</span>
        <span class="n">xml</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">"&lt;/UsernameToken&gt;"</span><span class="p">)</span>

        <span class="n">doc</span><span class="p">.</span><span class="n">LoadXml</span><span class="p">(</span><span class="n">xml</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span>

        <span class="k">Return</span> <span class="n">MessageHeader</span><span class="p">.</span><span class="n">CreateHeader</span><span class="p">(</span><span class="s">"Security"</span><span class="p">,</span> <span class="s">"http://docs.oasis-
open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd"</span><span class="p">,</span> <span class="n">doc</span><span class="p">.</span><span class="n">DocumentElement</span><span class="p">)</span>
    <span class="k">End</span> <span class="k">Function</span>

    <span class="k">Private</span> <span class="k">Function</span> <span class="nf">CreateI18nHeader</span><span class="p">()</span> <span class="ow">As</span> <span class="n">MessageHeader</span>
        <span class="k">Dim</span> <span class="nv">doc</span> <span class="ow">As</span> <span class="k">New</span> <span class="n">XmlDocument</span><span class="p">()</span>
        <span class="n">doc</span><span class="p">.</span><span class="n">LoadXml</span><span class="p">(</span><span class="s">"&lt;locale xmlns=</span><span class="se">""</span><span class="s">http://www.w3.org/2005/09/ws-i18n</span><span class="se">""</span><span class="s">&gt;en&lt;/locale&gt;"</span><span class="p">)</span>

        <span class="k">Return</span> <span class="n">MessageHeader</span><span class="p">.</span><span class="n">CreateHeader</span><span class="p">(</span><span class="s">"international"</span><span class="p">,</span> <span class="s">"http://www.w3.org/2005/09/ws-
i18n"</span><span class="p">,</span> <span class="n">doc</span><span class="p">.</span><span class="n">DocumentElement</span><span class="p">)</span>
    <span class="k">End</span> <span class="k">Function</span>
<span class="k">End</span> <span class="k">Class</span>

<span class="k">Public</span> <span class="k">Class</span> <span class="nc">HMLRBGMessageEndpointBehavior</span>
    <span class="k">Inherits</span> <span class="n">Attribute</span>
    <span class="k">Implements</span> <span class="n">IEndpointBehavior</span>
    <span class="k">Implements</span> <span class="n">IOperationBehavior</span>
    <span class="k">Implements</span> <span class="n">IContractBehavior</span>
<span class="cp">#Region "Member Variables"
</span>
    <span class="k">Private</span> <span class="n">m_Username</span> <span class="ow">As</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">Private</span> <span class="n">m_Password</span> <span class="ow">As</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>

<span class="cp">#End Region</span>

<span class="cp">#Region "Constructor"
</span>
    <span class="k">Public</span> <span class="k">Sub</span> <span class="nf">New</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">username</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">password</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">)</span>
        <span class="n">m_Username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="n">m_Password</span> <span class="o">=</span> <span class="n">password</span>
    <span class="k">End</span> <span class="k">Sub</span>

<span class="cp">#End Region</span>

<span class="cp">#Region "IEndpointBehavior Methods"
</span>
    <span class="k">Private</span> <span class="k">Sub</span> <span class="nf">IEndpointBehavior_AddBindingParameters</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">endpoint</span> <span class="ow">As</span> <span class="n">ServiceEndpoint</span><span class="p">,</span>
<span class="k">ByVal</span> <span class="n">bindingParameters</span> <span class="ow">As</span> <span class="n">BindingParameterCollection</span><span class="p">)</span> <span class="k">Implements</span>
<span class="n">IEndpointBehavior</span><span class="p">.</span><span class="n">AddBindingParameters</span>

    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Private</span> <span class="k">Sub</span> <span class="nf">IEndpointBehavior_ApplyClientBehavior</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">endpoint</span> <span class="ow">As</span> <span class="n">ServiceEndpoint</span><span class="p">,</span>
<span class="k">ByVal</span> <span class="n">clientRuntime</span> <span class="ow">As</span> <span class="n">System</span><span class="p">.</span><span class="n">ServiceModel</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="n">ClientRuntime</span><span class="p">)</span> <span class="k">Implements</span>
<span class="n">IEndpointBehavior</span><span class="p">.</span><span class="n">ApplyClientBehavior</span>
    <span class="n">clientRuntime</span><span class="p">.</span><span class="n">MessageInspectors</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">New</span> <span class="n">HMLRBGMessageInspector</span><span class="p">(</span><span class="n">m_Username</span><span class="p">,</span>
<span class="n">m_Password</span><span class="p">))</span>
    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Private</span> <span class="k">Sub</span> <span class="nf">IEndpointBehavior_ApplyDispatchBehavior</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">endpoint</span> <span class="ow">As</span> <span class="n">ServiceEndpoint</span><span class="p">,</span>
<span class="k">ByVal</span> <span class="n">endpointDispatcher</span> <span class="ow">As</span> <span class="n">System</span><span class="p">.</span><span class="n">ServiceModel</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="n">EndpointDispatcher</span><span class="p">)</span> <span class="k">Implements</span>
<span class="n">IEndpointBehavior</span><span class="p">.</span><span class="n">ApplyDispatchBehavior</span>

    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Private</span> <span class="k">Sub</span> <span class="nf">IEndpointBehavior_Validate</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">endpoint</span> <span class="ow">As</span> <span class="n">ServiceEndpoint</span><span class="p">)</span> <span class="k">Implements</span>
<span class="n">IEndpointBehavior</span><span class="p">.</span><span class="n">Validate</span>

    <span class="k">End</span> <span class="k">Sub</span>

<span class="cp">#End Region</span>

<span class="cp">#Region "IOperationBehavior Members"
</span>
    <span class="k">Private</span> <span class="k">Sub</span> <span class="nf">IOperationBehavior_AddBindingParameters</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">operationDescription</span> <span class="ow">As</span>
<span class="n">OperationDescription</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">bindingParameters</span> <span class="ow">As</span> <span class="n">BindingParameterCollection</span><span class="p">)</span> <span class="k">Implements</span>
<span class="n">IOperationBehavior</span><span class="p">.</span><span class="n">AddBindingParameters</span>

    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Private</span> <span class="k">Sub</span> <span class="nf">IOperationBehavior_ApplyClientBehavior</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">operationDescription</span> <span class="ow">As</span>
<span class="n">OperationDescription</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">clientOperation</span> <span class="ow">As</span> <span class="n">ClientOperation</span><span class="p">)</span> <span class="k">Implements</span>
<span class="n">IOperationBehavior</span><span class="p">.</span><span class="n">ApplyClientBehavior</span>

        <span class="n">clientOperation</span><span class="p">.</span><span class="n">Parent</span><span class="p">.</span><span class="n">MessageInspectors</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">New</span> <span class="n">HMLRBGMessageInspector</span><span class="p">(</span><span class="n">m_Username</span><span class="p">,</span>
<span class="n">m_Password</span><span class="p">))</span>

    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Private</span> <span class="k">Sub</span> <span class="nf">IOperationBehavior_ApplyDispatchBehavior</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">operationDescription</span> <span class="ow">As</span>
<span class="n">OperationDescription</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">dispatchOperation</span> <span class="ow">As</span> <span class="n">DispatchOperation</span><span class="p">)</span> <span class="k">Implements</span>
<span class="n">IOperationBehavior</span><span class="p">.</span><span class="n">ApplyDispatchBehavior</span>

        <span class="c1">'throw new NotImplementedException();</span>

    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Private</span> <span class="k">Sub</span> <span class="nf">IOperationBehavior_Validate</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">operationDescription</span> <span class="ow">As</span>
<span class="n">OperationDescription</span><span class="p">)</span> <span class="k">Implements</span> <span class="n">IOperationBehavior</span><span class="p">.</span><span class="n">Validate</span>

        <span class="c1">' throw new NotImplementedException();</span>

    <span class="k">End</span> <span class="k">Sub</span>

<span class="cp">#End Region</span>

<span class="cp">#Region "IContractBehavior Members"
</span>
    <span class="k">Private</span> <span class="k">Sub</span> <span class="nf">IContractBehavior_AddBindingParameters</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">contractDescription</span> <span class="ow">As</span>
<span class="n">ContractDescription</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">endpoint</span> <span class="ow">As</span> <span class="n">ServiceEndpoint</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">bindingParameters</span> <span class="ow">As</span>
<span class="n">BindingParameterCollection</span><span class="p">)</span> <span class="k">Implements</span> <span class="n">IContractBehavior</span><span class="p">.</span><span class="n">AddBindingParameters</span>

    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Private</span> <span class="k">Sub</span> <span class="nf">IContractBehavior_ApplyClientBehavior</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">contractDescription</span> <span class="ow">As</span>
<span class="n">ContractDescription</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">endpoint</span> <span class="ow">As</span> <span class="n">ServiceEndpoint</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">clientRuntime</span> <span class="ow">As</span>
<span class="n">ClientRuntime</span><span class="p">)</span> <span class="k">Implements</span> <span class="n">IContractBehavior</span><span class="p">.</span><span class="n">ApplyClientBehavior</span>
        <span class="n">clientRuntime</span><span class="p">.</span><span class="n">MessageInspectors</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">New</span> <span class="n">HMLRBGMessageInspector</span><span class="p">(</span><span class="n">m_Username</span><span class="p">,</span>
<span class="n">m_Password</span><span class="p">))</span>
    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Private</span> <span class="k">Sub</span> <span class="nf">IContractBehavior_ApplyDispatchBehavior</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">contractDescription</span> <span class="ow">As</span>
<span class="n">ContractDescription</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">endpoint</span> <span class="ow">As</span> <span class="n">ServiceEndpoint</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">dispatchRuntime</span> <span class="ow">As</span>
<span class="n">DispatchRuntime</span><span class="p">)</span> <span class="k">Implements</span> <span class="n">IContractBehavior</span><span class="p">.</span><span class="n">ApplyDispatchBehavior</span>

        <span class="c1">'throw new NotImplementedException();</span>

    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Private</span> <span class="k">Sub</span> <span class="nf">IContractBehavior_Validate</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">contractDescription</span> <span class="ow">As</span> <span class="n">ContractDescription</span><span class="p">,</span>
<span class="k">ByVal</span> <span class="n">endpoint</span> <span class="ow">As</span> <span class="n">ServiceEndpoint</span><span class="p">)</span> <span class="k">Implements</span> <span class="n">IContractBehavior</span><span class="p">.</span><span class="n">Validate</span>

        <span class="c1">'throw new NotImplementedException();</span>
    <span class="k">End</span> <span class="k">Sub</span>

<span class="cp">#End Region</span>

<span class="k">End</span> <span class="k">Class</span>

<span class="k">Public</span> <span class="k">Class</span> <span class="nc">AcceptAllCertificatePolicy</span>
    <span class="k">Implements</span> <span class="n">ICertificatePolicy</span>
    <span class="k">Public</span> <span class="k">Sub</span> <span class="nf">New</span><span class="p">()</span>
    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Public</span> <span class="k">Function</span> <span class="nf">CheckValidationResult</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">sPoint</span> <span class="ow">As</span> <span class="n">ServicePoint</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">cert</span> <span class="ow">As</span>
<span class="n">X509Certificate</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">wRequest</span> <span class="ow">As</span> <span class="n">WebRequest</span><span class="p">,</span> <span class="k">ByVal</span> <span class="n">certProb</span> <span class="ow">As</span> <span class="kt">Integer</span><span class="p">)</span> <span class="ow">As</span> <span class="kt">Boolean</span>
<span class="k">Implements</span> <span class="n">ICertificatePolicy</span><span class="p">.</span><span class="n">CheckValidationResult</span>
        <span class="c1">' *** Always accept</span>
        <span class="k">Return</span> <span class="k">True</span>
    <span class="k">End</span> <span class="k">Function</span>
<span class="k">End</span> <span class="k">Class</span>
</code></pre></div>


            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../../javascripts/application.js"></script>
  </body>
</html>
